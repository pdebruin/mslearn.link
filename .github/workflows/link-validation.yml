name: Link Validation

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual triggering

jobs:
  validate-links:
    runs-on: ubuntu-latest
    name: Validate Links
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v3

      - name: Check links from JSON
        id: check-links
        shell: bash
        run: |
          echo "Checking links from wwwroot/data/links.json..."
          
          failed_links=""
          success_count=0
          fail_count=0
          
          # Extract URLs from JSON file and process each line safely
          while IFS= read -r url; do
            echo "Checking: $url"
            
            # Use curl to check if URL responds with success (2xx or 3xx)
            http_code=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 30 -- "$url" 2>/dev/null || echo "000")
            
            if [[ "$http_code" =~ ^[23][0-9][0-9]$ ]]; then
              echo "  âœ“ OK ($http_code)"
              success_count=$((success_count + 1))
            else
              echo "  âœ— FAILED ($http_code)"
              failed_links="$failed_links- $url (HTTP $http_code)\n"
              fail_count=$((fail_count + 1))
            fi
          done < <(jq -r '.[].url' wwwroot/data/links.json)
          
          echo ""
          echo "================================"
          echo "Summary: $success_count succeeded, $fail_count failed"
          echo "================================"
          
          # Export values for use in subsequent steps
          echo "fail_count=$fail_count" >> $GITHUB_OUTPUT
          echo "success_count=$success_count" >> $GITHUB_OUTPUT
          
          # Store failed links in a file to preserve newlines
          if [ $fail_count -gt 0 ]; then
            echo ""
            echo "Failed links:"
            echo -e "$failed_links"
            echo -e "$failed_links" > /tmp/failed_links.txt
          fi

      - name: Create issue for broken links
        if: steps.check-links.outputs.fail_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const failedLinks = fs.readFileSync('/tmp/failed_links.txt', 'utf8');
            const failCount = '${{ steps.check-links.outputs.fail_count }}';
            const successCount = '${{ steps.check-links.outputs.success_count }}';
            
            const issueTitle = `ðŸ”— Broken Links Detected (${failCount} links)`;
            const totalLinks = Number(failCount) + Number(successCount);
            const issueBody = `## Link Validation Report
            
            The automated link validation workflow found **${failCount} broken link(s)** out of ${totalLinks} total links.
            
            ### Failed Links
            
            ${failedLinks}
            
            ### Action Required
            
            Please review the links above and either:
            - Fix the URLs if they have changed
            - Remove the links if the content is no longer available
            - Comment out the links temporarily if the issue is expected to be resolved
            
            ---
            *This issue was automatically created by the [Link Validation workflow](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}).*`;
            
            // Check if there's already an open issue with the same title pattern
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links'
            });
            
            const existingIssue = existingIssues.data.find(issue => issue.title.startsWith('ðŸ”— Broken Links Detected'));
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['broken-links']
              });
              console.log(`Created new issue #${newIssue.data.number}`);
            }
